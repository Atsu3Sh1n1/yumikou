<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>作業日報</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  @page { size: A4; margin: 10mm; }
  body { font-family: sans-serif; background:#f0f0f0; margin:0; }

  /* ページ全体 */
  .page {
    width: 210mm;
    margin: 0 auto;
    padding: 5mm 15mm 5mm 15mm;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    min-height: 287mm;
  }

          body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('yumikou.png');
            background-repeat: repeat;
            background-size: 400px 133px;
            opacity: 0.03;
            transform: rotate(-10deg);
            transform-origin: center;
            z-index: -1;
            pointer-events: none;
        }


  /* ヘッダー */
  .header-div {
    display:flex;
    align-items:center;
    gap:20px;
    border-bottom:2px solid #000;
    padding-bottom:5px;
    margin-bottom:10px;
    flex-wrap:nowrap;
    justify-content:space-between;
  }
  .header-left { display:flex; align-items:center; gap:20px; }
  .header-right { display:flex; align-items:center; gap:20px; justify-content:flex-end; }

  .header-div .title { font-size:20px; font-weight:bold; margin:0; }
  .company { font-size:20px; font-weight:bold; }
  .header-right input { font-size:18px; height:28px; text-align:center; font-weight:bold; }
  .name-input { width:110px; }
  .date-input { width:130px; }
  .header-right span { font-size:18px; font-weight:bold; }

  /* コントロールボタン */
  .controls { margin:10px 0; text-align:right; }
  @media print { .controls { display:none; } body{background:#fff;} }

  /* テーブル */
  table { width:100%; border-collapse:collapse; table-layout:fixed; }
  th, td { border:1px solid #000; padding:2px 4px; overflow:hidden; word-wrap:break-word; height:24px; text-align:center; }

  th.business-trip { width:6%; font-size:14px; }
  th.nightshift { width:6%; font-size:14px; }
  th.date { width:6%; font-size:14px; }
  th.weekday { width:6%; font-size:14px; }
  th.customer { width:20%; font-size:14px; }
  th.site { width:18%; font-size:14px; }
  th.work { width:18%; font-size:14px; }
  th.hours { width:6%; font-size:14px; }
  th.ot { width:6%; font-size:14px; }
  th.bento { width:6%; font-size:14px; }
  th.note { width:16%; font-size:14px; }

  /* 入力・テキストエリア */
  input, textarea { width:100%; border:none; background:transparent; font-size:14px; text-align:center; }
  textarea { resize:none; rows:1; height:20px; }

  /* 工数・残業・弁当の中央表示 */
  .sum-work,
  .sum-ot,
  .sum-bento {
    width:100%;
    height:20px;
    border:none;
    background:transparent;
    text-align:center;
    box-sizing:border-box;
    font-size:16px;
    font-weight:bold;
  }

  /* 数値入力のスピナー（矢印）を非表示 */
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  input[type="number"] {
    -moz-appearance: textfield;
  }

  /* スマホ専用スタイル */
  @media (max-width: 768px) {
    th, td {
      height: 28px;
      vertical-align: middle;
      padding: 3px 2px;
    }
    input, textarea {
      line-height: 22px;
      vertical-align: middle;
      padding: 3px 1px;
    }
    .sum-work, .sum-ot, .sum-bento {
      line-height: 22px;
      vertical-align: middle;
      padding: 3px 1px;
    }
    .header-right input {
      line-height: 24px;
      vertical-align: middle;
      padding: 2px;
    }
  }

  /* 下部合計欄 */
  .total-sums {
    display:flex;
    justify-content:center;
    gap:25px;
    font-size:16px;
    font-weight:bold;
    margin-top:10px;
    text-align:center;
  }
  .total-sums input {
    width:50px;
    border-bottom:1px solid #000;
    text-align:center;
    font-size:16px;
    font-weight:bold;
  }

  /* 月末以降の行を非表示 */
  .hidden-row {
    display: none;
  }

  @media screen {
    .hidden-row {
      visibility: hidden;
    }
  }

  /* ========= 印刷時の高さ崩れ対策 ========= */
  @media print {
    @page { size: A4; margin: 8mm; }
    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .page { width: 210mm; min-height: 280mm; max-height: 280mm; }
    table { width: 100%; table-layout: fixed; border-collapse: collapse; }
    th.business-trip, td:nth-child(1) { width: 4%; }
    th.nightshift, td:nth-child(2) { width: 4%; }
    th.date, td:nth-child(3) { width: 4%; }
    th.weekday, td:nth-child(4) { width: 4%; }
    th.customer, td:nth-child(5) { width: 20%; }
    th.site, td:nth-child(6) { width: 18%; }
    th.work, td:nth-child(7) { width: 20%; }
    th.hours, td:nth-child(8) { width: 6%; }
    th.ot, td:nth-child(9) { width: 6%; }
    th.bento, td:nth-child(10) { width: 6%; }
    th.note, td:nth-child(11) { width: 16%; }
    input, textarea { height: 20px; padding: 0; margin: 0; overflow: hidden; box-sizing: border-box; background: transparent; font-size: 13px; border: none; }
    .total-sums input { font-size: 18px; font-weight: bold; }
    .sum-work, .sum-ot, .sum-bento { font-size: 16px; font-weight: bold; }
    th, td { height: 24px; padding: 2px 4px; overflow: hidden; box-sizing: border-box; vertical-align: middle; font-size: 13px; }
    textarea { white-space: nowrap; resize: none; }
    .hidden-row { display: none; }
    .header-right input { font-size: 22px; font-weight: bold; height: 32px; }
    .header-right span { font-size: 22px; font-weight: bold; }
    input[type="month"]::-webkit-calendar-picker-indicator { display: none; }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }
  }

  

</style>
</head>
<body>
<div class="page">

<div class="header-div">
  <div class="header-left">
    <h2 class="title">有限会社 弓工 /</h2>
    <div class="company">作業日報</div>
  </div>
  <div class="header-right">
    <div class="header-item"><span>氏名：</span><input class="name-input"></div>
    <div class="header-item"><span>日付：</span><input id="month" type="month" class="date-input"></div>
  </div>
</div>

<div class="controls" style="margin-top:20px; text-align:right;">
  <button onclick="window.print()">PDF用に印刷</button>
  <button onclick="captureScreen()">スクリーンショット</button>
  <button onclick="clearData()">データクリア</button>
</div>

<table id="nippo-table">
  <thead>
    <tr>
      <th class="business-trip">出張</th>
      <th class="nightshift">夜勤</th>
      <th class="date">日付</th>
      <th class="weekday">曜日</th>
      <th class="customer">客先名</th>
      <th class="site">現場名称</th>
      <th class="work">作業内容</th>
      <th class="hours">工数</th>
      <th class="ot">残業</th>
      <th class="bento">弁当</th>
      <th class="note">備考</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="total-sums">
  <div>出張：<input id="total-business-trip" readonly>日</div>
  <div>夜勤：<input id="total-nightshift" readonly>日</div>
  <div>工数：<input id="total-work" readonly>人工</div>
  <div>残業：<input id="total-ot" readonly>ｈ</div>
  <div>弁当：<input id="total-bento" readonly>個</div>
</div>

</div>

<script>
const tbody = document.querySelector('tbody');
for (let i=1; i<=31; i++) {
  tbody.innerHTML += `<tr><td><input type="checkbox"></td><td><input type="checkbox"></td><td>${i}</td><td></td><td><input></td><td><input></td><td><textarea rows="1"></textarea></td><td><input type="number" class="sum-work" step="0.5"></td><td><input type="number" class="sum-ot" step="0.5"></td><td><input type="number" class="sum-bento" step="1"></td><td><textarea rows="1"></textarea></td></tr>`;
}

const wd = ["日","月","火","水","木","金","土"];

document.getElementById('month').onchange = ()=>{
  const v = document.getElementById('month').value;
  if (!v) return;
  const [y,m] = v.split('-').map(Number);
  const daysInMonth = new Date(y, m, 0).getDate();
  document.querySelectorAll('tbody tr').forEach((row,idx)=>{
    if (idx+1 > daysInMonth) {
      row.classList.add('hidden-row');
    } else {
      row.classList.remove('hidden-row');
      row.children[2].textContent = idx+1;
      row.children[3].textContent = wd[new Date(y, m-1, idx+1).getDay()];
    }
  });
  saveData();
};

function calcTotals(){
  let bt=0,n=0,w=0,o=0,b=0;
  document.querySelectorAll('tbody tr:not(.hidden-row)').forEach(tr=>{
    if(tr.children[0].querySelector('input').checked) bt++;
    if(tr.children[1].querySelector('input').checked) n++;
  });
  document.querySelectorAll('tbody tr:not(.hidden-row) .sum-work').forEach(e=>{ const v=+e.value; if(v) w+=v; });
  document.querySelectorAll('tbody tr:not(.hidden-row) .sum-ot').forEach(e=>{ const v=+e.value; if(v) o+=v; });
  document.querySelectorAll('tbody tr:not(.hidden-row) .sum-bento').forEach(e=>{ const v=+e.value; if(v) b+=v; });
  document.getElementById('total-business-trip').value = bt || '';
  document.getElementById('total-nightshift').value = n || '';
  document.getElementById('total-work').value = w || '';
  document.getElementById('total-ot').value = o || '';
  document.getElementById('total-bento').value = b || '';
}

document.oninput = e=>{
  if (e.target.matches('input,textarea')) {
    calcTotals();
    saveData();
  }
};

function saveData(){
  const data = [...document.querySelectorAll('tbody tr')].map(tr=>({
    businessTrip: tr.children[0].querySelector('input').checked,
    nightshift: tr.children[1].querySelector('input').checked,
    customer: tr.children[4].querySelector('input').value,
    site: tr.children[5].querySelector('input').value,
    work: tr.children[6].querySelector('textarea').value,
    hours: tr.children[7].querySelector('input').value,
    ot: tr.children[8].querySelector('input').value,
    bento: tr.children[9].querySelector('input').value,
    note: tr.children[10].querySelector('textarea').value
  }));
  localStorage.nippoData = JSON.stringify(data);
  localStorage.nippoMonth = document.getElementById('month').value;
  localStorage.nippoName = document.querySelector('.name-input').value;
}

function loadData(){
  if(localStorage.nippoMonth) document.getElementById('month').value = localStorage.nippoMonth;
  if(localStorage.nippoName) document.querySelector('.name-input').value = localStorage.nippoName;
  if(!localStorage.nippoData) return;
  
  JSON.parse(localStorage.nippoData).forEach((row,idx)=>{
    const tr = document.querySelectorAll('tbody tr')[idx];
    if(!tr) return;
    tr.children[0].querySelector('input').checked = row.businessTrip || false;
    tr.children[1].querySelector('input').checked = row.nightshift;
    tr.children[4].querySelector('input').value = row.customer;
    tr.children[5].querySelector('input').value = row.site;
    tr.children[6].querySelector('textarea').value = row.work;
    tr.children[7].querySelector('input').value = row.hours;
    tr.children[8].querySelector('input').value = row.ot;
    tr.children[9].querySelector('input').value = row.bento;
    tr.children[10].querySelector('textarea').value = row.note;
  });
  document.getElementById('month').onchange();
  calcTotals();
}

function clearData(){
  if(confirm('作業データを削除します。よろしいですか？')){
    delete localStorage.nippoData;
    delete localStorage.nippoMonth;
    delete localStorage.nippoName;
    location.reload();
  }
}

function captureScreen(){
  const element = document.querySelector('.page');
  
  if (!window.html2canvas) {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
    script.onload = () => {
      html2canvas(element, {
        scale: 2,
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#f0f0f0'
      }).then(canvas => {
        const link = document.createElement('a');
        link.download = '作業日報_' + (document.getElementById('month').value || 'screenshot') + '.png';
        link.href = canvas.toDataURL();
        link.click();
      });
    };
    document.head.appendChild(script);
  } else {
    html2canvas(element, {
      scale: 2,
      useCORS: true,
      allowTaint: true,
      backgroundColor: '#f0f0f0'
    }).then(canvas => {
      const link = document.createElement('a');
      link.download = '作業日報_' + (document.getElementById('month').value || 'screenshot') + '.png';
      link.href = canvas.toDataURL();
      link.click();
    });
  }
}

window.onload = loadData;
</script>

</body>
</html>
