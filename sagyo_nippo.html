<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>作業日報</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  @page { size: A4; margin: 10mm; }
  body { font-family: sans-serif; background:#f0f0f0; margin:0; }

  /* ページ全体 */
  .page {
    width: 210mm;
    margin: 0 auto;
    padding: 5mm 15mm 5mm 15mm;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    min-height: 287mm;
  }

          body::before {
            content: "";
            position: fixed;
            top: -4%;
            left: 50%;
            width: 180vw;
            height: 180vh;
            background-image: url('yumikou.png');
            background-repeat: repeat;
            background-size: 300px 100px;
            opacity: 0.03;
            transform: translateX(-50%) rotate(-10deg);
            transform-origin: center;
            z-index: -1;
            pointer-events: none;
             background-attachment: fixed;
        }

        /* スマホ対応の透かし調整 */
        @media (max-width: 768px) {
          body::before {
            background-size: 200px 67px;
            width: 200vw;
            height: 200vh;
          }
        }


  /* ヘッダー */
  .header-div {
    display:flex;
    align-items:center;
    gap:20px;
    border-bottom:2px solid #000;
    padding-bottom:5px;
    margin-bottom:10px;
    flex-wrap:nowrap;
    justify-content:space-between;
  }
  .header-left { display:flex; align-items:center; gap:20px; }
  .header-right { display:flex; align-items:center; gap:20px; justify-content:flex-end; }

  .header-div .title { font-size:20px; font-weight:bold; margin:0; }
  .company { font-size:20px; font-weight:bold; }
  .header-right input { font-size:18px; height:28px; text-align:center; font-weight:bold; }
  .name-input { width:110px; }
  .date-input { width:130px; }
  .header-right span { font-size:18px; font-weight:bold; }

  /* コントロールボタン */
  .controls { margin:10px 0; text-align:right; }
  @media print { .controls { display:none; } body{background:#fff;} }

  /* テーブル */
  table { width:100%; border-collapse:collapse; table-layout:fixed; }
  th, td { border:1px solid #000; padding:2px 4px; overflow:hidden; word-wrap:break-word; height:24px; text-align:center; }

  th.nightshift { width:6%; font-size:14px; }
  th.date { width:6%; font-size:14px; }
  th.weekday { width:6%; font-size:14px; }
  th.customer { width:22%; font-size:14px; }
  th.site { width:20%; font-size:14px; }
  th.work { width:20%; font-size:14px; }
  th.hours { width:8%; font-size:12px; }
  th.ot { width:8%; font-size:12px; }
  th.bento { width:8%; font-size:10px; }
  th.note { width:18%; font-size:12px; }

  /* 入力・テキストエリア */
  input, textarea { width:100%; border:none; background:transparent; font-size:14px; text-align:center; }
  textarea { resize:none; rows:1; height:20px; }

  /* 工数・残業・弁当の中央表示 */
  .sum-work,
  .sum-ot,
  .sum-bento {
    width:100%;
    height:20px;
    border:none;
    background:transparent;
    text-align:center;
    box-sizing:border-box;
    font-size:16px;
    font-weight:bold;
  }

  /* 下部合計欄 */
  .total-sums {
    display:flex;
    justify-content:center; /* 中央揃え */
    gap:40px;
    font-size:18px;
    font-weight:bold;
    margin-top:10px;
    text-align:center; /* 子も中央揃え */
  }
  .total-sums input {
    width:70px;
    border-bottom:1px solid #000;
    text-align:center;
    font-size:18px;
    font-weight:bold;
  }

  /* 月末以降の行を非表示 */
  .hidden-row {
    display: none;
  }

  @media screen {
    .hidden-row {
      visibility: hidden;
    }
  }

  /* ========= 印刷時の高さ崩れ対策 ========= */
  @media print {
    /* iOS Safari対策: A4サイズ */
    @page { size: A4; margin: 8mm; }
    
    /* ページ全体の固定 */
    .page {
      width: 210mm !important;
      min-height: 280mm !important;
      max-height: 280mm !important;
      transform-origin: top left;
    }

    /* テーブル全体の固定 */
    table {
      width: 100% !important;
      table-layout: fixed !important;
      border-collapse: collapse !important;
    }

    /* セル幅の強制固定（A4最適化） */
    th.nightshift, td:nth-child(1) { width: 4% !important; }
    th.date, td:nth-child(2) { width: 4% !important; }
    th.weekday, td:nth-child(3) { width: 4% !important; }
    th.customer, td:nth-child(4) { width: 22% !important; }
    th.site, td:nth-child(5) { width: 20% !important; }
    th.work, td:nth-child(6) { width: 22% !important; }
    th.hours, td:nth-child(7) { width: 6% !important; }
    th.ot, td:nth-child(8) { width: 6% !important; }
    th.bento, td:nth-child(9) { width: 6% !important; }
    th.note, td:nth-child(10) { width: 18% !important; }

    /* 入力欄の高さ固定（スマホPDF対策） */
    input, textarea {
      height: 20px !important;
      min-height: 20px !important;
      max-height: 20px !important;
      line-height: 20px !important;
      padding: 0 !important;
      margin: 0 !important;
      overflow: hidden !important;
      box-sizing: border-box !important;
      background: transparent !important;
      font-size: 14px !important;
      border: none !important;
    }
    
    /* 合計欄の数字を太く表示（スマホ対策） */
    .total-sums input {
      font-size: 18px !important;
      font-weight: bold !important;
    }
    
    /* テーブル内の数値入力も太く */
    .sum-work, .sum-ot, .sum-bento {
      font-size: 16px !important;
      font-weight: bold !important;
    }

    /* テーブル行の高さ固定（iOS対策強化） */
    table tr, th, td {
      height: 24px !important;
      min-height: 24px !important;
      max-height: 24px !important;
      padding: 2px 4px !important;
      overflow: hidden !important;
      word-wrap: break-word !important;
      box-sizing: border-box !important;
      vertical-align: middle !important;
    }
    
    /* iOS Safari特有の高さ変動対策 */
    table {
      -webkit-transform: translateZ(0) !important;
      transform: translateZ(0) !important;
    }

    /* textarea の改行による縦伸び禁止 */
    textarea {
      white-space: nowrap !important;
      resize: none !important;
    }

    /* 非表示行は印刷時は完全に削除 */
    .hidden-row {
      display: none !important;
    }

    /* iOS Safari PDF出力対策 */
    body {
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }

    /* フォントサイズの微調整でレイアウト安定化 */
    th, td {
      font-size: 13px !important;
    }

    input, textarea {
      font-size: 13px !important;
    }

    /* スマホPDF出力時の名前・日付を大きく表示 */
    .header-right input {
      font-size: 22px !important;
      font-weight: bold !important;
      height: 32px !important;
    }
    
    .header-right span {
      font-size: 22px !important;
      font-weight: bold !important;
    }
  }

  

</style>
</head>
<body>
<div class="page">

<div class="header-div">
  <div class="header-left">
    <h2 class="title">有限会社 弓工 /</h2>
    <div class="company">作業日報</div>
  </div>
  <div class="header-right">
    <div class="header-item"><span>氏名：</span><input class="name-input"></div>
    <div class="header-item"><span>日付：</span><input id="month" type="month" class="date-input"></div>
  </div>
</div>

<div class="controls" style="margin-top:20px; text-align:right;">
  <button onclick="window.print()">PDF用に印刷</button>
  <button onclick="clearData()">データクリア</button>
</div>

<table id="nippo-table">
  <thead>
    <tr>
      <th class="nightshift">夜勤</th>
      <th class="date">日付</th>
      <th class="weekday">曜日</th>
      <th class="customer">客先名</th>
      <th class="site">現場名称</th>
      <th class="work">作業内容</th>
      <th class="hours">工数</th>
      <th class="ot">残業</th>
      <th class="bento">弁当</th>
      <th class="note">備考</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="total-sums">
  <div>工数：<input id="total-work" readonly>人工</div>
  <div>残業：<input id="total-ot" readonly>ｈ</div>
  <div>弁当：<input id="total-bento" readonly>個</div>
</div>

</div>

<script>
const tbody = document.querySelector('tbody');
for (let i=1; i<=31; i++) {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="checkbox" class="nightshift-check"></td>
    <td>${i}</td>
    <td class="weekday"></td>
    <td><input></td>
    <td><input></td>
    <td><textarea rows="1"></textarea></td>
    <td><input type="number" class="sum-work" step="0.5"></td>
    <td><input type="number" class="sum-ot" step="0.5"></td>
    <td><input type="number" class="sum-bento" step="1"></td>
    <td><textarea rows="1"></textarea></td>`;
  tbody.appendChild(tr);
}

const wd = ["日","月","火","水","木","金","土"];

document.getElementById('month').addEventListener('change', ()=>{
  const v = document.getElementById('month').value;
  if (!v) return;
  const [y,m] = v.split('-').map(Number);
  const daysInMonth = new Date(y, m, 0).getDate();
  const rows = document.querySelectorAll('tbody tr');
  rows.forEach((row,idx)=>{
    if (idx+1 > daysInMonth) {
      row.classList.add('hidden-row');
      row.children[1].textContent = '';
      row.children[2].textContent = '';
    } else {
      row.classList.remove('hidden-row');
      row.children[1].textContent = idx+1;
      const d = new Date(y, m-1, idx+1);
      row.children[2].textContent = wd[d.getDay()];
    }
  });
  saveData();
});

function calcTotals(){
  let w=0,o=0,b=0;
  document.querySelectorAll('tbody tr:not(.hidden-row) .sum-work').forEach(e=>{ const v=parseFloat(e.value); if(!isNaN(v)) w+=v; });
  document.querySelectorAll('tbody tr:not(.hidden-row) .sum-ot').forEach(e=>{ const v=parseFloat(e.value); if(!isNaN(v)) o+=v; });
  document.querySelectorAll('tbody tr:not(.hidden-row) .sum-bento').forEach(e=>{ const v=parseFloat(e.value); if(!isNaN(v)) b+=v; });
  document.getElementById('total-work').value = w? w.toFixed(1) : '';
  document.getElementById('total-ot').value = o? o.toFixed(1) : '';
  document.getElementById('total-bento').value = b? b : '';
}

document.addEventListener('input', e=>{
  if (e.target.classList.contains('sum-work') || e.target.classList.contains('sum-ot') || e.target.classList.contains('sum-bento') ||
      e.target.tagName==='INPUT' || e.target.tagName==='TEXTAREA') {
    calcTotals();
    saveData();
  }
});

function saveData(){
  const data = [];
  document.querySelectorAll('tbody tr').forEach(tr=>{
    data.push({
      nightshift: tr.children[0].querySelector('input').checked,
      customer: tr.children[3].querySelector('input').value,
      site: tr.children[4].querySelector('input').value,
      work: tr.children[5].querySelector('textarea').value,
      hours: tr.children[6].querySelector('input').value,
      ot: tr.children[7].querySelector('input').value,
      bento: tr.children[8].querySelector('input').value,
      note: tr.children[9].querySelector('textarea').value
    });
  });
  localStorage.setItem('nippoData', JSON.stringify(data));
  localStorage.setItem('nippoMonth', document.getElementById('month').value);
  localStorage.setItem('nippoName', document.querySelector('.name-input').value);
}

function loadData(){
  const dataStr = localStorage.getItem('nippoData');
  const month = localStorage.getItem('nippoMonth');
  const name = localStorage.getItem('nippoName');

  if(month) document.getElementById('month').value = month;
  if(name) document.querySelector('.name-input').value = name;

  if(!dataStr) return;

  const data = JSON.parse(dataStr);
  data.forEach((row,idx)=>{
    const tr = document.querySelectorAll('tbody tr')[idx];
    if(!tr) return;
    tr.children[0].querySelector('input').checked = row.nightshift;
    tr.children[3].querySelector('input').value = row.customer;
    tr.children[4].querySelector('input').value = row.site;
    tr.children[5].querySelector('textarea').value = row.work;
    tr.children[6].querySelector('input').value = row.hours;
    tr.children[7].querySelector('input').value = row.ot;
    tr.children[8].querySelector('input').value = row.bento;
    tr.children[9].querySelector('textarea').value = row.note;
  });

  const event = new Event('change');
  document.getElementById('month').dispatchEvent(event);

  calcTotals();
}

function clearData(){
  if(confirm('作業データを削除します。よろしいですか？')){
    localStorage.removeItem('nippoData');
    localStorage.removeItem('nippoMonth');
    localStorage.removeItem('nippoName');
    location.reload();
  }
}

window.addEventListener('load', loadData);
</script>

</body>
</html>
