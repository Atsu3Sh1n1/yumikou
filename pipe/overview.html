<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>配管ライン色分け</title>
  <style>
    body { font-family: sans-serif; padding: 10px; }
    canvas { border: 1px solid #ccc; max-width: 100%; }
  </style>
  
</head>
<body>
  <h3>PDFアップロードして配管ライン表示</h3>
  <input type="file" id="fileInput" accept="application/pdf">
  <canvas id="pdfCanvas"></canvas>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
  <script>
    const fileInput = document.getElementById('fileInput');
    const canvas = document.getElementById('pdfCanvas');
    const ctx = canvas.getContext('2d');

    let pdfDoc = null;
    let currentLineWidth = 1;
    let currentDash = [];
    let currentX = 0;
    let currentY = 0;
    let lines = [];

    const colors = ["#e6194b", "#3cb44b", "#ffe119", "#4363d8", "#f58231", "#911eb4"];
    let colorIndex = 0;

    function getNextColor() {
      return colors[(colorIndex++) % colors.length];
    }

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const arrayBuffer = await file.arrayBuffer();
      pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

      const page = await pdfDoc.getPage(1);
      const scale = 1.5;
      const viewport = page.getViewport({ scale });

      canvas.width = viewport.width;
      canvas.height = viewport.height;

      const opList = await page.getOperatorList();
      lines = [];
      currentDash = [];

      for (let i = 0; i < opList.fnArray.length; i++) {
        const fn = opList.fnArray[i];
        const args = opList.argsArray[i];

        switch (fn) {
          case pdfjsLib.OPS.setLineWidth:
            currentLineWidth = args[0];
            break;
          case pdfjsLib.OPS.setLineDash:
            currentDash = args[0];
            break;
          case pdfjsLib.OPS.moveTo:
            currentX = args[0] * scale;
            currentY = canvas.height - args[1] * scale;
            break;
          case pdfjsLib.OPS.lineTo:
            const x2 = args[0] * scale;
            const y2 = canvas.height - args[1] * scale;
            lines.push({
              x1: currentX,
              y1: currentY,
              x2: x2,
              y2: y2,
              width: currentLineWidth,
              isDashed: currentDash.length > 0
            });
            currentX = x2;
            currentY = y2;
            break;
        }
      }

      // 実線-点線-実線のセットを探す
      const used = new Set();
      for (let i = 0; i < lines.length - 2; i++) {
        const l1 = lines[i];
        const l2 = lines[i + 1];
        const l3 = lines[i + 2];

        if (!l1.isDashed && l2.isDashed && !l3.isDashed && !used.has(i)) {
          const color = getNextColor();
          [l1, l2, l3].forEach(l => {
            ctx.strokeStyle = color;
            ctx.lineWidth = l.width;
            if (l.isDashed) ctx.setLineDash([5, 5]);
            else ctx.setLineDash([]);
            ctx.beginPath();
            ctx.moveTo(l.x1, l.y1);
            ctx.lineTo(l.x2, l.y2);
            ctx.stroke();
          });
          used.add(i);
          used.add(i + 1);
          used.add(i + 2);
        }
      }
    });
  </script>
</body>
</html>
