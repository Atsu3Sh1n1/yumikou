<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>プラント工事配管溶接現場DB重量見積計算機｜有限会社弓工</title>
  <link rel="icon" href="images/icon.webp" type="image/x-icon" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- 追加: html2canvas の CDN を head に追加 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <style>
    body {
      margin: 0;
      padding: 20px 0;
      background: #f9f9f9;
      font-family: sans-serif;
    }

    iframe {
      display: block;
      width: 100%;
      max-width: 800px;
      height: 800px;
      margin: 0 auto 30px;
      border: none;
    }

    .pdf-button {
      display: block;
      margin: 20px auto;
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .pdf-button:hover {
      background-color: #45a049;
    }
  </style>
</head>

<body>
  <div class="manual-header" style="text-align: center; margin: 20px 0;">
    <a href="manual.html" style="
    display: inline-block;
    padding: 12px 24px;
    background: linear-gradient(135deg, #2c7be5, #1a5cb0);
    color: white;
    text-decoration: none;
    border-radius: 50px;
    font-weight: bold;
    font-size: 1.1rem;
    box-shadow: 0 4px 12px rgba(44, 123, 229, 0.3);
    transition: all 0.3s ease;
    border: 2px solid #1a5cb0;
  ">
      🛠️ 見積りガイド 🧑‍🔧
    </a>

  </div>

  <!-- 各 iframe にIDをつける -->
  <iframe id="app1" src="estimate.html" loading="lazy"></iframe>
  <div style="text-align: center;">
    <a href="pipe.html">説明書</a>
  </div>

  <iframe id="app2" src="Pipe_Weight.html" loading="lazy"></iframe>
  <div style="text-align: center;">
    <a href="db_manual.html">説明書</a>
  </div>

  <iframe id="app3" src="welding_cost_calculator.html" loading="lazy"></iframe>

  <iframe id="app4" src="hi.html" loading="lazy"></iframe>

  <iframe id="pipeForm" src="so.html" loading="lazy"></iframe>

  <!-- PDF出力ボタン -->
  <button class="pdf-button" onclick="generatePDF()">試作PDF出力、調整中</button>

  <footer style="text-align:center; padding:0.5rem;">
    <a href="https://atsu3sh1n1.github.io/yumikou/" style="color:#000; text-decoration:none;">
      有限会社弓工 All rights reserved.
    </a>
  </footer>



<script>
  const supabaseUrl = 'https://whofjiwzkwxzimsburln.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indob2ZqaXd6a3d4emltc2J1cmxuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc1NzQyMTAsImV4cCI6MjA2MzE1MDIxMH0.aJOLS1GWYTORJPC2AqhqwzTUUGXPedotFuZsY0ymVaE';
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  async function generatePDF() {
    const waitForIframeLoad = (iframe) => {
      return new Promise((resolve) => {
        if (iframe.contentDocument?.readyState === 'complete') {
          resolve();
        } else {
          iframe.onload = () => resolve();
        }
      });
    };

    const iframeIds = ["app1", "app2", "app3", "app4", "pipeForm"];
    await Promise.all(
      iframeIds.map(id => waitForIframeLoad(document.getElementById(id)))
    );

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'pt', format: 'a4' });

    const PAGE_WIDTH = doc.internal.pageSize.getWidth();
    const PAGE_HEIGHT = doc.internal.pageSize.getHeight();
    const MARGIN = 40;
    const HEADER_HEIGHT = 60;
    const FOOTER_HEIGHT = 30;
    const ACCENT_COLOR = '#003366';

    const logoBase64 = ""; // 任意のロゴ画像Base64

    doc.setFillColor(ACCENT_COLOR);
    doc.rect(0, 0, PAGE_WIDTH, HEADER_HEIGHT, 'F');

    if (logoBase64) doc.addImage(logoBase64, 'PNG', 345, 22.5, 20, 20);

    const today = new Date();
    const jstOffset = 9 * 60;
    const localOffset = today.getTimezoneOffset();
    const jst = new Date(today.getTime() + (jstOffset + localOffset) * 60000);

    const issueDate = jst.toISOString().split('T')[0];

    const validUntilDate = new Date(jst);
    validUntilDate.setMonth(validUntilDate.getMonth() + 1);
    const validUntil = validUntilDate.toISOString().split('T')[0];

    doc.setFontSize(10);
    doc.setTextColor(255);
    doc.text(`Issue Date: ${issueDate}`, MARGIN, 25);
    doc.text(`Valid Until: ${validUntil}`, MARGIN, 40);

    doc.setFontSize(20);
    doc.text('YUMIKOU CO.,LTD.', PAGE_WIDTH - MARGIN, 40, { align: 'right' });

    const addFooter = (pageNum, totalPages) => {
      const y = PAGE_HEIGHT - FOOTER_HEIGHT + 10;
      doc.setFontSize(10);
      doc.setTextColor(150);
      doc.text(`Page ${pageNum} / ${totalPages}`, PAGE_WIDTH - MARGIN, y, { align: 'right' });
    };

    const iframes = [
      { id: "app1", label: "Total Person-Days" },
      { id: "app2", label: "Pipe Length / Weight" },
      { id: "app3", label: "Complete Welding" },
      { id: "app4", label: "Wrecker / 高所作業車" },
      { id: "pipeForm", label: "Item Description" }
    ];

    const rows = [];
    let grandTotal = 0;
    const validFrames = [];

    for (const frame of iframes) {
      try {
        const iframe = document.getElementById(frame.id);
        const data = iframe.contentWindow.getEstimateData();
        if (!data || data.subtotal === 0) continue;

        const workLoad =
          frame.id === 'app3'
            ? `${data.totalDB?.toFixed(1) ?? 'N/A'} DB`
            : frame.id === 'app1'
              ? `${data.manhour ?? 'N/A'} Days`
              : frame.id === 'app2'
                ? `${data.pipeLength ?? 'N/A'} m / ${data.pipeWeight ?? 'N/A'} kg`
                : "N/A";

        rows.push([
          frame.label,
          `¥${data.subtotal.toLocaleString()}`,
          workLoad
        ]);

        grandTotal += data.subtotal;
        validFrames.push({ ...frame, data });
      } catch (e) {}
    }

    const roundDownTotal = (amount) => {
      if (amount < 1_000_000) return Math.floor(amount / 10_000) * 10_000;
      if (amount < 10_000_000) return Math.floor(amount / 100_000) * 100_000;
      return Math.floor(amount / 1_000_000) * 1_000_000;
    };

    const roundedTotal = roundDownTotal(grandTotal);
    const taxAmount = Math.floor(roundedTotal * 0.1);
    const totalWithTax = roundedTotal + taxAmount;

    const totalBoxY = HEADER_HEIGHT + 10;
    doc.setFillColor(255, 255, 200);
    doc.roundedRect(MARGIN, totalBoxY, PAGE_WIDTH - MARGIN * 2, 70, 4, 4, 'F');
    doc.setTextColor(0);
    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.text("Total (Tax Included)", MARGIN + 10, totalBoxY + 20);
    doc.text(`¥${totalWithTax.toLocaleString()}`, PAGE_WIDTH - MARGIN - 10, totalBoxY + 20, { align: 'right' });

    doc.setFont("helvetica", "normal");
    doc.setFontSize(11);
    doc.text("Total (Excl. Tax)", MARGIN + 10, totalBoxY + 40);
    doc.text(`¥${roundedTotal.toLocaleString()}`, PAGE_WIDTH - MARGIN - 10, totalBoxY + 40, { align: 'right' });
    doc.text("Consumption Tax (10%)", MARGIN + 10, totalBoxY + 60);
    doc.text(`¥${taxAmount.toLocaleString()}`, PAGE_WIDTH - MARGIN - 10, totalBoxY + 60, { align: 'right' });

    doc.autoTable({
      startY: HEADER_HEIGHT + 90,
      margin: { left: MARGIN, right: MARGIN },
      head: [['Type', 'Sub Total', 'Work Load']],
      body: rows,
      theme: 'grid',
      headStyles: { fillColor: ACCENT_COLOR, textColor: 255 },
      styles: { fontSize: 11, cellPadding: 8 },
      alternateRowStyles: { fillColor: [245, 245, 245] }
    });

    let pipeData = [];
    try {
      const pipeIframe = document.getElementById('pipeForm');
      pipeData = pipeIframe.contentWindow.getPipeFormData();
    } catch (e) {}

    const hasNonEmptyRow = pipeData.some(row =>
      (row.size && row.size.trim()) || (row.material && row.material.trim())
    );

    if (hasNonEmptyRow) {
      doc.addPage();
      doc.setFontSize(14);
      doc.text("Item Description", MARGIN, 40);
      const head = ['Size', 'Material', 'Schedule (SCH)', 'Fitting Typ', 'Valve Type', 'Quantity', 'Unit'];
      const body = pipeData.filter(row =>
        (row.size && row.size.trim()) || (row.material && row.material.trim())
      ).map(row => [
        row.size || '', row.material || '', row.schedule || '', row.shape || '',
        row.valveType || '', row.cutLength || row.quantity || '', row.unit || ''
      ]);

      doc.autoTable({
        startY: 60,
        head: [head],
        body,
        margin: { left: MARGIN, right: MARGIN },
        styles: { fontSize: 10 },
        headStyles: { fillColor: ACCENT_COLOR, textColor: 255 }
      });
    }

    for (const frame of validFrames) {
      try {
        const iframe = document.getElementById(frame.id);
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        const canvas = await html2canvas(iframeDoc.body, { scale: 2, useCORS: true });
        const imgData = canvas.toDataURL('image/png');
        const imgProps = doc.getImageProperties(imgData);
        const pdfWidth = PAGE_WIDTH - MARGIN * 2;
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

        doc.addPage();
        doc.setFontSize(14);
        doc.text(frame.label, MARGIN, 40);
        doc.addImage(imgData, 'PNG', MARGIN, 60, pdfWidth, Math.min(pdfHeight, PAGE_HEIGHT - 100));
      } catch (err) {
        doc.addPage();
        doc.text(`${frame.label} - スクリーンショット取得失敗`, MARGIN, 50);
      }
    }

    const totalPages = doc.internal.getNumberOfPages();
    for (let i = 1; i <= totalPages; i++) {
      doc.setPage(i);
      const y = PAGE_HEIGHT - FOOTER_HEIGHT + 10;
      doc.setFontSize(10);
      doc.setTextColor(150);
      doc.text(`Page ${i} / ${totalPages}`, PAGE_WIDTH - MARGIN, y, { align: 'right' });
    }

    // PDF blob を URL にして保存
    const blob = doc.output("blob");
    const pdfUrl = URL.createObjectURL(blob);
    doc.save("YUMIKOU Inc.pdf");

    // Supabase に登録
    const estimateNumber = "Q-" + issueDate.replace(/-/g, "") + "-" + Math.floor(Math.random() * 9000 + 1000);
    const customerName = "未入力"; // あれば iframe から取得してここに反映
    const { data, error } = await supabase
      .from("estimates")
      .insert([
        {
          estimate_number: estimateNumber,
          customer_name: customerName,
          pdf_url: pdfUrl
        }
      ]);

    if (error) {
      console.error("❌ Supabase 登録失敗:", error.message);
    } else {
      console.log("✅ Supabase 登録成功:", data);
    }
  }
</script>

</body>

</html>