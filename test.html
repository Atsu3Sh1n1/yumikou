<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>見積もりシステム｜有限会社弓工</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .pdf-button {
      display: block;
      margin: 20px auto;
      padding: 12px 24px;
      background-color: #003366;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
    }
    iframe {
      width: 100%;
      border: 1px solid #ddd;
      margin-bottom: 20px;
      background: white;
    }
    footer {
      text-align: center;
      padding: 20px;
      margin-top: 30px;
      color: #666;
    }
  </style>
</head>
<body>
  <iframe id="app1" src="estimate.html" loading="lazy"></iframe>
  <iframe id="app2" src="Pipe_Weight.html" loading="lazy"></iframe>
  <iframe id="app3" src="welding_cost_calculator.html" loading="lazy"></iframe>
  <iframe id="app4" src="hi.html" loading="lazy"></iframe>
  <iframe id="app5" src="yo.html" loading="lazy"></iframe>
  <iframe id="pipeForm" src="so.html" loading="lazy"></iframe>

  <button class="pdf-button" onclick="generatePDF()">見積書作成/PDF出力</button>

  <footer>
    <a href="https://atsu3sh1n1.github.io/yumikou/" style="color:#000; text-decoration:none;">
      有限会社弓工 All rights reserved.
    </a>
  </footer>

  <script>
    // iframeの読み込みとデータ取得を確実にする関数
    const waitForIframeAndData = async (iframeId) => {
      const iframe = document.getElementById(iframeId);
      
      // iframeの読み込みを待つ
      await new Promise(resolve => {
        if (iframe.contentDocument?.readyState === 'complete') {
          resolve();
        } else {
          iframe.onload = resolve;
        }
      });
      
      // データ取得を試みる（最大3回までリトライ）
      let retries = 3;
      while (retries > 0) {
        try {
          const data = iframe.contentWindow.getEstimateData();
          if (data) return data;
        } catch (e) {
          console.warn(`Retrying data fetch for ${iframeId}...`);
        }
        await new Promise(resolve => setTimeout(resolve, 500));
        retries--;
      }
      return null;
    };

    async function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });

      const PAGE_WIDTH = doc.internal.pageSize.getWidth();
      const PAGE_HEIGHT = doc.internal.pageSize.getHeight();
      const MARGIN = 40;
      const HEADER_HEIGHT = 60;
      const FOOTER_HEIGHT = 30;
      const ACCENT_COLOR = '#003366';

      // ヘッダー
      doc.setFillColor(ACCENT_COLOR);
      doc.rect(0, 0, PAGE_WIDTH, HEADER_HEIGHT, 'F');

      // 日付情報
      const today = new Date();
      const jstOffset = 9 * 60;
      const localOffset = today.getTimezoneOffset();
      const jst = new Date(today.getTime() + (jstOffset + localOffset) * 60000);

      const issueDate = jst.toLocaleDateString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      }).replace(/\//g, '-');

      const validUntilDate = new Date(jst);
      validUntilDate.setMonth(validUntilDate.getMonth() + 1);
      const validUntil = validUntilDate.toLocaleDateString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      }).replace(/\//g, '-');

      doc.setFontSize(10);
      doc.setTextColor(255);
      doc.text(`発行日: ${issueDate}`, MARGIN, 25);
      doc.text(`有効期限: ${validUntil}`, MARGIN, 40);

      doc.setFontSize(20);
      doc.text('有限会社 弓工', PAGE_WIDTH - MARGIN, 40, { align: 'right' });

      // iframeデータ収集
      const iframes = [
        { id: "app1", label: "工数見積" },
        { id: "app2", label: "配管重量計算" },
        { id: "app3", label: "溶接工数" },
        { id: "app4", label: "リフト・クレーン" },
        { id: "pipeForm", label: "物品明細" }
      ];

      const rows = [];
      let grandTotal = 0;
      let taxableTotal = 0;

      for (const frame of iframes) {
        try {
          const data = await waitForIframeAndData(frame.id);
          if (!data || data.subtotal === 0) continue;

          // 配管重量計算(app2)の特別処理
          if (frame.id === 'app2' && data.allData) {
            data.allData.forEach((item, index) => {
              rows.push([
                `${frame.label} #${index + 1}`,
                `¥${item.subtotal.toLocaleString()}`,
                `${item.size}A / ${item.pipeLength}m / ${item.pipeWeight}kg`
              ]);
              grandTotal += item.subtotal;
              taxableTotal += item.subtotal;
            });
          } else {
            const workLoad = frame.id === 'app3' ? `${data.totalDB?.toFixed(1) ?? '-'} DB` :
                          frame.id === 'app1' ? `${data.manhour ?? '-'} 人日` :
                          frame.id === 'app4' ? `${data.hours ?? '-'} 時間` : '-';
            
            rows.push([
              frame.label,
              `¥${data.subtotal.toLocaleString()}`,
              workLoad
            ]);
            
            grandTotal += data.subtotal;
            if (frame.id !== 'app5') taxableTotal += data.subtotal;
          }
        } catch (e) {
          console.error(`Error processing ${frame.id}:`, e);
        }
      }

      // 税計算
      const roundDownTotal = (amount) => amount < 1000 ? amount : Math.floor(amount / 1000) * 1000;
      const roundedTaxableTotal = roundDownTotal(taxableTotal);
      const taxRate = 0.1;
      const taxAmount = Math.floor(roundedTaxableTotal * taxRate);
      const totalWithTax = grandTotal + taxAmount;

      // 合計ボックス
      const totalBoxY = HEADER_HEIGHT + 10;
      const totalBoxHeight = 70;
      doc.setFillColor(255, 255, 200);
      doc.roundedRect(MARGIN, totalBoxY, PAGE_WIDTH - MARGIN * 2, totalBoxHeight, 4, 4, 'F');
      doc.setTextColor(0);
      doc.setFontSize(12);
      doc.setFont("helvetica", "bold");
      doc.text("税込合計", MARGIN + 10, totalBoxY + 20);
      doc.text(`¥${totalWithTax.toLocaleString()}`, PAGE_WIDTH - MARGIN - 10, totalBoxY + 20, { align: 'right' });

      doc.setFont("helvetica", "normal");
      doc.setFontSize(11);
      doc.text("税抜合計", MARGIN + 10, totalBoxY + 40);
      doc.text(`¥${roundedTaxableTotal.toLocaleString()}`, PAGE_WIDTH - MARGIN - 10, totalBoxY + 40, { align: 'right' });

      doc.text("消費税 (10%)", MARGIN + 10, totalBoxY + 60);
      doc.text(`¥${taxAmount.toLocaleString()}`, PAGE_WIDTH - MARGIN - 10, totalBoxY + 60, { align: 'right' });

      // メインテーブル
      doc.autoTable({
        startY: HEADER_HEIGHT + 90,
        margin: { left: MARGIN, right: MARGIN },
        head: [['項目', '金額', '詳細']],
        body: rows,
        theme: 'grid',
        headStyles: { fillColor: ACCENT_COLOR, textColor: 255, fontStyle: 'bold' },
        styles: { font: 'helvetica', fontSize: 11, cellPadding: 8 },
        alternateRowStyles: { fillColor: [245, 245, 245] },
      });

      // 物品明細の追加 (pipeForm)
      try {
        const pipeFormIframe = document.getElementById('pipeForm');
        const pipeData = pipeFormIframe.contentWindow.getPipeFormData?.() || [];
        
        if (pipeData.length > 0) {
          doc.addPage();
          doc.setFontSize(14);
          doc.text("物品明細", MARGIN, 40);

          doc.autoTable({
            startY: 60,
            head: [['サイズ', '材質', 'スケジュール', '形状', '数量', '単位']],
            body: pipeData.map(item => [
              item.size || '-',
              item.material || '-',
              item.schedule || '-',
              item.shape || '-',
              item.quantity || '-',
              item.unit || '-'
            ]),
            margin: { left: MARGIN, right: MARGIN },
            styles: { fontSize: 10 },
            headStyles: { fillColor: ACCENT_COLOR, textColor: 255 },
          });
        }
      } catch (e) {
        console.error("物品明細の取得に失敗:", e);
      }

      // スクリーンショット追加
      for (const frame of iframes) {
        try {
          const iframe = document.getElementById(frame.id);
          const canvas = await html2canvas(iframe, {
            scale: 1,
            useCORS: true,
            backgroundColor: '#ffffff',
            logging: false
          });

          const imgData = canvas.toDataURL('image/jpeg', 0.8);
          const imgProps = doc.getImageProperties(imgData);
          const pdfWidth = PAGE_WIDTH - MARGIN * 2;
          const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

          doc.addPage();
          doc.setFontSize(14);
          doc.text(frame.label, MARGIN, 20);
          doc.addImage(imgData, 'JPEG', MARGIN, 30, pdfWidth, pdfHeight);
        } catch (e) {
          console.error(`${frame.label} スクリーンショット失敗:`, e);
        }
      }

      // ページ番号
      const totalPages = doc.internal.getNumberOfPages();
      for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFontSize(10);
        doc.setTextColor(150);
        doc.text(`ページ ${i}/${totalPages}`, PAGE_WIDTH - MARGIN, PAGE_HEIGHT - 20, { align: 'right' });
      }

      doc.save(`弓工_見積書_${issueDate}.pdf`);
    }
  </script>
</body>
</html>